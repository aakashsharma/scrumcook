<% if workable_item.new_record?
       item_unique_id = "icebox_new_workable_item"
       item_type_image_source = "/images/Story.png"
       item_estimate_image_source = "/images/estimate-1pt.gif"
   else
       item_unique_id = "#{workable_item.id}"
       item_type_image_source = "/images/#{workable_item.type}.png"
       item_estimate_image_source = "/images/estimate#{workable_item.estimate}pt.gif"
   end
%>

<div id="<%= "#{item_unique_id}_detail" %>" class="item" style="display:none">
<div id="<%= "#{item_unique_id}_content" %>" class="storyItem unscheduled unestimated underEdit jquery_file_upload">
<%= form_for([workable_item.project, workable_item], :remote => true, :html => {:multipart => true}) do |project_form| %>
    <% project_users = workable_item.project.active_users %>

    <div class="storyPreviewHeader">
      <% if !workable_item.new_record? %>
          <div class="storySelector notDblclickable">&nbsp;</div>
          <div class="icons">
            <img id="<%= "#{item_unique_id}_cancel_edit_button" %>" class="toggleExpandedButton cancelEditButton" src="/images/story_expanded.png" title="Collapse">
          </div>
      <% end %>
      <div class="storyPreviewInput">
        <%= project_form.text_area :title,
                                   :cols => 1,
                                   :rows => 1,
                                   :id =>"#{item_unique_id}_title",
                                   :class => 'titleInputField autoresize expand17-99999' %>
        <div class="clear">
        </div>
      </div>
      <div class="text_example">e.g. As a role, I want goal so that benefit</div>
      <div class="error_message" id="<%= "#{item_unique_id}_workable_item_error_message" %>" style="display:none;"></div>
    </div>
    <div class="storyDetailElement">
    <div class="storyDetails">
    <div class="buttons">
      <div class="storyDetailsButton">
        <%= project_form.submit 'Save', :class => "story_save", :id => "#{item_unique_id}_save_button" %>
        <input id="<%= "#{item_unique_id}_cancel_edit_button" %>" class="cancelEditButton" type="button" value="Cancel">
        <% if !workable_item.new_record? %>
            <%= link_to 'Delete', project_workable_item_path(workable_item.project, workable_item), :confirm => "Are you sure you want to delete the #{workable_item.type}?", :method => :delete, :remote => true %>
        <% else %>
            <input type="submit" value="Delete" disabled="disabled">
            <input type="submit" value="View history" disabled="disabled">
        <% end %>
      </div>
    </div>
    <table class="storyDetailsTable">
      <tbody>
      <tr>
        <td colspan="1" class="letContentExpand">
          <div>
            <%= project_form.select(:type, WorkableItem.types,
                                    {:selected => workable_item.new_record? ? 'Story' : workable_item.type},
                                    {:class => "storyDetailsField workable_item_type_select",
                                     :id => "#{item_unique_id}_type"}) %>
          </div>
        </td>
        <td colspan="1" class="storyDetailsLabelIcon">
          <img id="<%= "#{item_unique_id}_type_image" %>" src="<%= item_type_image_source %>">
        </td>
        <td colspan="1" class="lastCell">
          <div id="<%= "#{item_unique_id}_help_story_types" %>">
            <img src="/images/question_mark.gif" class="helpIcon">

            <div class="tooltip">
              <div class="storyTitle">Story Types</div>
              <div class="sectionDivider">
              </div>
              <div class="tooltip_desc">There are 4 types of story:
                <ul>
                  <li>A <b>Feature</b> is a story that provides verifiable business value to the team's customer.
                    Usually it is requested by the customer.
                  </li>
                  <li>A <b>Chore</b> is a story that does not provide verifiable business value to the team's customer
                    but is deemed necessary by the team in order to keep moving forward. Usually it is not requested by
                    the customer.
                  </li>
                  <li>A <b>Bug</b> is a story that describes a defect in some accepted story.</li>
                  <li>A <b>Release marker</b> is a story that marks the end of some group of stories that constitutes a
                    release.
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="1">
          <div>
            <%= project_form.select(:estimate, WorkableItem.estimates,
                                    {:selected => workable_item.new_record? ? -1 : workable_item.estimate},
                                    {:class => "storyDetailsField workable_item_estimate_select",
                                     :id => "#{item_unique_id}_estimate",
                                     :disabled => (!workable_item.new_record? and !workable_item.is_estimatable?)}) %>
          </div>
        </td>
        <td colspan="1" class="storyDetailsLabelIcon">
          <% if workable_item.new_record? or workable_item.is_estimatable? %>
              <img id="<%= "#{item_unique_id}_estimate_image" %>" src="<%= item_estimate_image_source %>">
          <% end %>
        </td>
        <td colspan="1">
          <div id="<%= "#{item_unique_id}_help_estimates" %>">
            <img src="/images/question_mark.gif" class="helpIcon">

            <div class="tooltip">
              <div class="storyTitle">Estimates</div>
              <div class="sectionDivider">
              </div>
              <div class="tooltip_desc">We estimate Features in <b>Points</b>. A Point is a team-specific measurement
                of the effort required to implement a Feature. Estimates are used to calculate the team's
                <b>Velocity</b>.
              </div>
            </div>
          </div>
        </td>
      </tr>
      <% if !workable_item.new_record? %>
          <tr>
            <td>
              <div>
                <%= project_form.select(:status, WorkableItem.aasm_states_for_select,
                                        {:class => "storyDetailsField workable_item_estimate_select",
                                         :id => "#{item_unique_id}_status"}) %>
              </div>
            </td>
            <td colspan="3">
            </td>
          </tr>
      <% end %>
      <tr>
        <td>
          <div>
            <%= project_form.collection_select(:requester, project_users, :id, :display_name, {}, {:class => "storyDetailsField"}) %>
          </div>
        </td>
        <td colspan="3">
          <label id="workable_item_requester_label" for="workable_item_requester">
            <div>
              <div class="emphasizedFieldLabel">requested</div>
              <div class="fieldLabel">this story</div>
            </div>
          </label>
        </td>
      </tr>
      <tr>
        <td colspan="1">
          <div>
            <%= project_form.collection_select(:owner, project_users, :id, :display_name, {:prompt => "none"}, {:class => "storyDetailsField"}) %>
          </div>
        </td>
        <td colspan="3">
          <label>
            <div>
              <div class="emphasizedFieldLabel">owns</div>
              <div class="fieldLabel">this story</div>
            </div>
          </label>
        </td>
      </tr>
      </tbody>
    </table>
    <div class="section">
      <div class="header">
        <div class="label">Labels</div>
      </div>
      <div class="wrapper token_wrapper">
        <%= project_form.text_field :label_tokens,
                                    :class => "labels",
                                    :id => "#{item_unique_id}_labels",
                                    "data-pre" => workable_item.labels.all.to_json,
                                    "data-url" => "/labels.json?project_id=#{workable_item.project.id}" %>
      </div>
    </div>
    <div class="section">
      <div class="storyDescriptionTable">
        <div class="header">
          <div class="label">Description</div>
          <div id="<%= "#{item_unique_id}_help_story_description" %>">
            <img src="/images/question_mark.gif" class="helpIcon">

            <div class="tooltip">
              <div class="storyTitle">Description</div>
              <div class="sectionDivider"></div>
              <div class="tooltip_desc">A story's description should contain the criteria for the acceptance of the
                story. This may take the form of user requirements, acceptance tests, a link to an external document,
                etc.
              </div>
            </div>
          </div>
          <div class="clear">
          </div>
        </div>
        <div>
          <%= project_form.text_area :description, :cols => 1, :rows => 1, :class => 'textAreaFocus description_area autoresize expand17-99999' %>
        </div>
      </div>
    </div>
    <div class="taskTableDiv">
      <div class="section">
        <div id="<%= "#{item_unique_id}_tasks_header" %>" class="header">
          Tasks <span class="count">(<%= workable_item.tasks.count %>)</span>
        </div>
        <ol id="<%= "#{item_unique_id}_tasks" %>" class="task_list ui-sortable">
          <% project_form.fields_for :tasks do |task_builder| %>
              <%= render :partial => 'workable_items/task_fields', :locals => {:f => task_builder} %>
          <% end %>
        </ol>
        <div class="add_task">
          <textarea id="<%= "#{item_unique_id}_new_task_description" %>"
                    cols="1" rows="1"
                    class="tasksTextArea autoresize expand17-99999 new_task_text">add new task</textarea>
              <span id="<%= "#{item_unique_id}_new_task_add_link" %>" class="add_task" style="display:none;">
                <%= link_to_add_task_fields "Add", project_form, :tasks, item_unique_id %>
              </span>
        </div>
      </div>
    </div>
    <div class="commentTableDiv">
      <div class="section">
        <div id="<%= "#{item_unique_id}_comments_header" %>" class="header">
          Comments <span class="commentCount">(<%= workable_item.comments.count %>)</span>
        </div>
        <table class="commentsTable">
          <tbody id="<%= "#{item_unique_id}_comments" %>">
          <% project_form.fields_for :comments do |comment_builder| %>
              <%= render :partial => 'workable_items/comment_fields', :locals => {:f => comment_builder} %>
          <% end %>
          </tbody>
        </table>
        <div class="add_comment">
          <textarea id="<%= "#{item_unique_id}_new_comment_description" %>"
                    cols="20" rows="1"
                    class="tasksTextArea autoresize expand17-99999 new_comment_text">add new comment</textarea>

          <div class="commentText">(Format using *<b>bold</b>* and _<i>italic</i>_ text.)</div>
              <span id="<%= "#{item_unique_id}_new_comment_add_link" %>" class="add_comment" style="display:none;">
                <%= link_to_add_comment_fields "Add", project_form, :comments, item_unique_id %>
              </span>
        </div>
      </div>
    </div>
    <%= project_form.hidden_field :category %>
    <%= project_form.hidden_field :priority %>
    <%= project_form.hidden_field :epic_id %>
    <%= project_form.hidden_field :project_id, {:value => workable_item.project.id} %>
    <div class="attachmentWidget">
      <div class="section attachments">
        <div id="<%= "#{item_unique_id}_attachments_header" %>" class="header">
          Attachments <span class="count">(<%= workable_item.workable_item_attachments.count %>)</span>
        </div>
        <ol id="<%= "#{item_unique_id}_attachments_list" %>" class="attachments_list">
          <% project_form.fields_for :workable_item_attachments do |workable_item_attachment_builder| %>
              <% if !workable_item_attachment_builder.object.new_record? %>
                  <%= render :partial => 'workable_items/attachment_fields', :locals => {:f => workable_item_attachment_builder} %>
              <% end %>
          <% end %>
        </ol>
      </div>
    </div>
<% end %>
<%= render :partial => 'workable_item_attachments/form' %>
</div>
</div>
</div>
</div>